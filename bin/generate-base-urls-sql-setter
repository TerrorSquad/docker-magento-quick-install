#!/bin/bash
set -ex

STORES=$(bin/mysql <"config/sql/get_stores.sql" | tail -n -1 | jq)

echo "use magento;"

COUNTER=0
for STORE_ID in $(echo $STORES | jq -r '.[].store_id'); do
    if [[ "$STORE_ID" -gt 1 ]]; then
        STORE_CODE=$(echo $STORES | jq -r ".[${COUNTER}].code")
        SECURE_BASE_URL="https://magento-${STORE_CODE}.test/"
        UNSECURE_BASE_URL="http://magento-${STORE_CODE}.test/"
        SECURE_BASE_LINK_URL="https://magento-${STORE_CODE}.test/"
        UNSECURE_BASE_LINK_URL="http://magento-${STORE_CODE}.test/"
        SQL_SECURE_BASE_URL="UPDATE core_config_data ccd SET ccd.value = '${SECURE_BASE_URL}' WHERE ccd.path = 'web/secure/base_url' AND scope_id = ${STORE_ID};"
        echo $SQL_SECURE_BASE_URL
        SQL_UNSECURE_BASE_URL="UPDATE core_config_data ccd SET ccd.value = '${UNSECURE_BASE_URL}' WHERE ccd.path = 'web/unsecure/base_url' AND scope_id = ${STORE_ID};"
        echo $SQL_UNSECURE_BASE_URL
        SQL_SECURE_BASE_LINK_URL="UPDATE core_config_data ccd SET ccd.value = '${SECURE_BASE_LINK_URL}' WHERE ccd.path = 'web/secure/base_link_url' AND scope_id = ${STORE_ID};"
        echo $SQL_SECURE_BASE_LINK_URL
        SQL_UNSECURE_BASE_LINK_URL="UPDATE core_config_data ccd SET ccd.value = '${UNSECURE_BASE_LINK_URL}' WHERE ccd.path = 'web/unsecure/base_link_url' AND scope_id = ${STORE_ID};"
        echo $SQL_UNSECURE_BASE_LINK_URL
    fi
    COUNTER=$(("$COUNTER+1"))
done
