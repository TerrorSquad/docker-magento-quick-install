#!/bin/bash

MODE=$(bin/clinotty cat /usr/local/etc/php/php.ini | grep -iPo 'xdebug.mode = .+' | grep -iPo '(?! )\w*$')

xdebug_status() {
    echo "Xdebug mode is ${MODE}."
}

xdebug_toggle() {
    if [[ $MODE != 'debug' ]]; then
        xdebug_enable
    else
        xdebug_disable
    fi
}

xdebug_enable() {
    if [[ $MODE == 'off' ]]; then
        bin/root sed -r -i -e 's/^xdebug.mode = .+/xdebug.mode = debug/g' /usr/local/etc/php/php.ini
        sleep 1
        bin/restart phpfpm
        echo "Xdebug debug mode has been enabled."
    else
        echo "Xdebug debug mode is already enabled."
    fi
}

xdebug_enable_profiling() {
    if [[ $MODE != 'profile' ]]; then
        bin/root sed -r -i -e 's/^xdebug.mode = .+/xdebug.mode = profile/g' /usr/local/etc/php/php.ini
        sleep 1
        bin/restart phpfpm
        echo "Xdebug profile mode has been enabled."
    else
        echo "Xdebug profile mode is already enabled."
    fi
}

xdebug_disable() {
    if [[ $MODE != 'off' ]]; then
        bin/root sed -r -i -e 's/^xdebug.mode = .+/xdebug.mode = off/g' /usr/local/etc/php/php.ini
        sleep 1
        bin/restart phpfpm
        echo "Xdebug debug mode has been disabled."
    else
        echo "Xdebug debug mode is already disabled."
    fi
}

firstArgLetter="$(echo "$1" | head -c 1)"

if [[ $firstArgLetter == "d" ]]; then
    xdebug_disable
elif [[ $firstArgLetter == "e" ]]; then
    xdebug_enable
elif [[ $firstArgLetter == "p" ]]; then
    xdebug_enable_profiling
elif [[ $firstArgLetter == "t" ]]; then
    xdebug_toggle
elif [[ $firstArgLetter == "s" ]]; then
    xdebug_status
else
    printf "Please specify either 'disable', 'enable', 'profile', 'status' or 'toggle' as an argument.\nEx: bin/xdebug status\n"
fi
